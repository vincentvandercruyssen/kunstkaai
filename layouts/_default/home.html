{{ define "main" }}
<style>
  header {
    display: none;
  }

  main {
    grid-column: 1 / 3;
    margin: 0;
    padding: 1rem;
  }

  .grid-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
  }

  .folder {
    max-height: 70vh;
    overflow-y: scroll;
    mask-image: linear-gradient(180deg, black 95%, transparent);
  }

  h3 {
    overflow: hidden;
    max-width: 20ch;
    font-size: 1.5rem;
    white-space: nowrap;
    text-overflow: ellipsis;
  }

  h4 {
    font-size: 1.2rem;
  }

  time.pill {
    opacity: 0.5;
    font-size: 0.9rem;
  }
</style>


{{/* Top-level sections = jaren (nieuwste eerst) */}}
{{ range .Site.Sections.ByTitle.Reverse }}
  <section class="year">
    <h2><a href="{{ .Title | default .Section }}">{{ .Title | default .Section }}</a></h2>

    {{/* alle paginaâ€™s onder dit jaar, zonder op sections te vertrouwen */}}
    {{ $yearPages := .RegularPagesRecursive }}
    {{ $year := .Title | default .Section }}

    {{/* unieke vakkeys uit URL na /{jaar}/ ; enkel tonen als in params.sectionNames */}}
    {{ $vakKeys := slice }}
    {{ range $yearPages }}
      {{ $afterYear := replaceRE (printf "^.*/%s/" $year) "" .RelPermalink }}
      {{ $s := split (trim $afterYear "/") "/" }}
      {{ if ge (len $s) 1 }}
        {{ $vak := index $s 0 }}
        {{ if and (index $.Site.Params.sectionNames $vak) (not (in $vakKeys $vak)) }}
          {{ $vakKeys = $vakKeys | append $vak }}
        {{ end }}
      {{ end }}
    {{ end }}
    {{ $vakKeys = sort $vakKeys }}

    <div class="grid-container">
      {{ range $vakKeys }}
        {{ $vak := . }}
        <div class="folder">
          <h3><a href="{{ printf "%s/%s/" $year $vak | relURL }}">{{ index $.Site.Params.sectionNames $vak }}</a></h3>

          {{/* ---------- CURSUS op vakniveau: /jaar/vak/cursus/... ---------- */}}
          <div class="cursus">
            <h4>Cursusmateriaal</h4>
            <ul>
              {{ $cursusPrefix := printf "/%s/%s/cursus/" $year $vak }}
              {{ range sort $yearPages "Date" "desc" }}
                {{ if in .RelPermalink $cursusPrefix }}
                  <li>
                    <a href="{{ .Permalink }}" target="_blank">{{ .Title | default .File.BaseFileName }}</a>
                  </li>
                {{ end }}
              {{ end }}
            </ul>
          </div>

          {{/* ---------- OPDRACHTEN per KLAS: /jaar/vak/<klas>/opdracht/... ---------- */}}
          {{ $klassen := slice }}
          {{ range $yearPages }}
            {{ if and (in .RelPermalink (printf "/%s/%s/" $year $vak)) (in .RelPermalink "/opdracht/") }}
              {{ $afterVak := replaceRE (printf "^.*/%s/%s/" $year $vak) "" .RelPermalink }}
              {{ $p := split (trim $afterVak "/") "/" }}
              {{ if ge (len $p) 1 }}
                {{ $klas := index $p 0 }}
                {{ if not (in $klassen $klas) }}{{ $klassen = $klassen | append $klas }}{{ end }}
              {{ end }}
            {{ end }}
          {{ end }}
          {{ $klassen = sort $klassen }}

          {{ range $klassen }}
            {{ $klas := . }}
            <div class="opdracht">
              <h4>Opdrachten ({{ upper $klas }})</h4>
              <ul>
                {{ $klasPrefix := printf "/%s/%s/%s/" $year $vak $klas }}
                {{ range sort $yearPages "Date" "desc" }}
                  {{ if and (in .RelPermalink $klasPrefix) (in .RelPermalink "/opdracht/") }}
                    <li>
                      <a href="{{ .Permalink }}" target="_blank">
                        {{ .Title | default .File.BaseFileName }}
                      </a> <br>
                      <time datetime="{{ .Date | time.Format $.Site.Params.dateFormatISO }}" class="pill">
                        {{ .Date | time.Format $.Site.Params.dateFormat }}
                      </time>
                    </li>
                  {{ end }}
                {{ end }}
              </ul>
            </div>
          {{ end }}
        </div>
      {{ end }}
    </div>
  </section>
{{ end }}
{{ end }}